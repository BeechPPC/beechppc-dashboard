generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Recipient {
  id                   String                 @id
  email                String                 @unique
  name                 String?
  enabled              Boolean                @default(true)
  timezone             String?
  preferredFormat      RecipientFormat?       @default(BOTH)
  unsubscribedAt       DateTime?
  unsubscribeToken     String?                @unique
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  RecipientGroupMember RecipientGroupMember[]

  @@index([email])
  @@index([enabled])
}

model RecipientGroup {
  id                   String                 @id
  name                 String
  description          String?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  RecipientGroupMember RecipientGroupMember[]

  @@index([name])
}

model RecipientGroupMember {
  id             String         @id
  recipientId    String
  groupId        String
  createdAt      DateTime       @default(now())
  RecipientGroup RecipientGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  Recipient      Recipient      @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([recipientId, groupId])
  @@index([groupId])
  @@index([recipientId])
}

model ReportHistory {
  id               String          @id
  scheduleId       String?
  reportType       ReportType
  reportName       String
  generatedAt      DateTime        @default(now())
  dateFrom         DateTime
  dateTo           DateTime
  accountIds       Json
  accountNames     Json
  htmlContent      String?
  pdfUrl           String?
  jsonData         Json?
  status           ReportStatus    @default(PENDING)
  deliveryStatus   Json?
  sentTo           Json?
  sentAt           DateTime?
  fileSizeBytes    Int?
  generationTimeMs Int?
  errorMessage     String?
  createdAt        DateTime        @default(now())
  expiresAt        DateTime?
  ReportSchedule   ReportSchedule? @relation(fields: [scheduleId], references: [id])

  @@index([createdAt])
  @@index([generatedAt])
  @@index([reportType])
  @@index([scheduleId])
  @@index([status])
}

model ReportSchedule {
  id              String          @id
  name            String
  description     String?
  reportType      ReportType
  frequency       ReportFrequency
  enabled         Boolean         @default(true)
  cronSchedule    String
  timezone        String          @default("Australia/Melbourne")
  nextRunAt       DateTime?
  lastRunAt       DateTime?
  lastRunStatus   String?
  scopeType       ScopeType
  accountIds      Json?
  templateType    TemplateType
  sections        Json
  dateRangeType   DateRangeType
  recipientEmails Json
  createdBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  deletedAt       DateTime?
  ReportHistory   ReportHistory[]

  @@index([createdAt])
  @@index([enabled])
  @@index([nextRunAt])
}

model ReportTemplate {
  id               String   @id
  name             String
  description      String?
  templateType     String
  sections         Json
  defaultDateRange String?
  isSystem         Boolean  @default(false)
  isPublic         Boolean  @default(false)
  createdBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime

  @@index([createdBy])
  @@index([isPublic])
  @@index([isSystem])
}

enum DateRangeType {
  YESTERDAY
  LAST_7_DAYS
  LAST_30_DAYS
  THIS_MONTH
  LAST_MONTH
  CUSTOM
}

enum RecipientFormat {
  HTML
  PDF
  BOTH
}

enum ReportFrequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM_CRON
}

enum ReportStatus {
  PENDING
  GENERATING
  GENERATED
  SENDING
  SENT
  FAILED
}

enum ReportType {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum ScopeType {
  MCC
  ACCOUNTS
  ALL
}

enum TemplateType {
  EXECUTIVE
  DETAILED
  KEYWORD
  AUCTION
  CUSTOM
}
